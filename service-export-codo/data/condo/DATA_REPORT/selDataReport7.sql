
SELECT TYY1.CONDO_B_ID, TYY1.BUILD_NO, TYY3.OFLEVEL, TYY1.OFLEVEL_ORDER, TYY1.MIN_S_D_FUR_AR, TYY1.MAX_S_D_FUR_AR, TYY2.S_D_FUR_AR, TYY2.DATE_PRICE, TYY4.ROOM_TYPE_NAME, TYY4.ROOM_TYPE_ID
FROM (
SELECT TTX1.CONDO_B_ID, TTX1.BUILD_NO, TTX1.OFLEVEL_ORDER, MIN(TTX1.S_D_FUR_AR) MIN_S_D_FUR_AR, MAX(TTX1.S_D_FUR_AR) MAX_S_D_FUR_AR
  FROM (
  SELECT TTA1.CONDO_B_ID, TTA1.BUILD_NO, TTA1.OFLEVEL_ORDER, CAST(ROUND((TTA1.S_D_FUR / TTA1.AREA_CONTRACT),0) AS int) AS S_D_FUR_AR
  FROM(
    SELECT T4.CONDO_B_ID, T4.BUILD_NO, T3.OFLEVEL_ORDER, (ISNULL(T1.PRICE_S,0) - ISNULL(T1.PRICE_DISCOUNT,0) - ISNULL(T1.PRICE_FUR_EDIT_AREA,0)) AS S_D_FUR, T1.AREA_CONTRACT
    FROM(
    SELECT CONDO_S_ID, CONDO_H_ID, PRICE_S, PRICE_DISCOUNT, (PRICE_FUR_EDIT_AREA * AREA_CONTRACT) PRICE_FUR_EDIT_AREA, AREA_CONTRACT
    FROM condo.dbo.NCONDO_SALES_ROOM
    WHERE CONDO_S_ID = @CONDO_S_ID
    ) T1
    LEFT OUTER JOIN
    (
    SELECT CONDO_S_ID, CONDO_H_ID, CONDO_L_ID
    FROM condo.dbo.NCONDO_HEADER
    ) T2
    ON T1.CONDO_S_ID = T2.CONDO_S_ID
    AND T1.CONDO_H_ID = T2.CONDO_H_ID
    LEFT OUTER JOIN
    (
    SELECT CONDO_S_ID, CONDO_B_ID, CONDO_L_ID, OFLEVEL, OFLEVEL_ORDER
    FROM condo.dbo.NCONDO_LEVEL
    ) T3
    ON T1.CONDO_S_ID = T3.CONDO_S_ID
    AND T2.CONDO_L_ID = T3.CONDO_L_ID
    LEFT OUTER JOIN
    (
    SELECT CONDO_S_ID, CONDO_B_ID, BUILD_NO
    FROM condo.dbo.NCONDO_BUILD
    ) T4
    ON T1.CONDO_S_ID = T4.CONDO_S_ID
    AND T3.CONDO_B_ID = T4.CONDO_B_ID
  ) TTA1
) TTX1
GROUP BY TTX1.CONDO_B_ID, TTX1.BUILD_NO, TTX1.OFLEVEL_ORDER
) TYY1
LEFT OUTER JOIN
(
SELECT TTM1.CONDO_B_ID, TTM1.BUILD_NO, TTM1.OFLEVEL_ORDER, TTM1.S_D_FUR_AR, TTM1.DATE_PRICE, TTM1.ROOM_TYPE_ID
FROM (
SELECT TTL1.Row_NUM, TTL1.CONDO_B_ID, TTL1.BUILD_NO, TTL1.OFLEVEL_ORDER, TTL1.S_D_FUR_AR, ROW_NUMBER() OVER(PARTITION BY TTL1.BUILD_NO, TTL1.OFLEVEL_ORDER ORDER BY TTL1.BUILD_NO, TTL1.OFLEVEL_ORDER, TTL1.S_D_FUR_AR DESC) AS Row_NUM2, TTL1.DATE_PRICE, TTL1.ROOM_TYPE_ID
FROM (
  SELECT ROW_NUMBER() OVER(PARTITION BY TTX1.BUILD_NO, TTX1.OFLEVEL_ORDER ORDER BY TTX1.BUILD_NO, TTX1.OFLEVEL_ORDER, TTX1.S_D_FUR_AR) AS Row_NUM, TTX1.CONDO_B_ID, TTX1.BUILD_NO, TTX1.OFLEVEL_ORDER, TTX1.S_D_FUR_AR, TTX1.DATE_PRICE, TTX1.ROOM_TYPE_ID
  FROM (
  SELECT TTA1.CONDO_B_ID, TTA1.BUILD_NO, TTA1.OFLEVEL_ORDER, CAST(ROUND((TTA1.S_D_FUR / TTA1.AREA_CONTRACT),0) AS int) AS S_D_FUR_AR, DATE_PRICE, ROOM_TYPE_ID
    FROM(
      SELECT T4.CONDO_B_ID, T4.BUILD_NO, T3.OFLEVEL_ORDER, (ISNULL(T1.PRICE_S,0) - ISNULL(T1.PRICE_DISCOUNT,0) - ISNULL(T1.PRICE_FUR_EDIT_AREA,0)) AS S_D_FUR, T1.AREA_CONTRACT, T1.DATE_PRICE, T2.ROOM_TYPE_ID
      FROM(
      SELECT CONDO_S_ID, CONDO_H_ID, PRICE_S, PRICE_DISCOUNT, (PRICE_FUR_EDIT_AREA * AREA_CONTRACT) PRICE_FUR_EDIT_AREA, AREA_CONTRACT, FORMAT(CAST(DATE_PRICE AS date),N'yyyy','th-TH') DATE_PRICE
      FROM condo.dbo.NCONDO_SALES_ROOM
      WHERE CONDO_S_ID = @CONDO_S_ID
      ) T1
      LEFT OUTER JOIN
      (
      SELECT CONDO_S_ID, CONDO_H_ID, CONDO_L_ID, ROOM_TYPE_ID
      FROM condo.dbo.NCONDO_HEADER
      ) T2
      ON T1.CONDO_S_ID = T2.CONDO_S_ID
      AND T1.CONDO_H_ID = T2.CONDO_H_ID
      LEFT OUTER JOIN
      (
      SELECT CONDO_S_ID, CONDO_B_ID, CONDO_L_ID, OFLEVEL, OFLEVEL_ORDER
      FROM condo.dbo.NCONDO_LEVEL
      ) T3
      ON T1.CONDO_S_ID = T3.CONDO_S_ID
      AND T2.CONDO_L_ID = T3.CONDO_L_ID
      LEFT OUTER JOIN
      (
      SELECT CONDO_S_ID, CONDO_B_ID, BUILD_NO
      FROM condo.dbo.NCONDO_BUILD
      ) T4
      ON T1.CONDO_S_ID = T4.CONDO_S_ID
      AND T3.CONDO_B_ID = T4.CONDO_B_ID
    ) TTA1
  ) TTX1
) TTL1
WHERE TTL1.Row_NUM < 3
) TTM1
WHERE TTM1.Row_NUM2 = 1
) TYY2
ON TYY1.CONDO_B_ID = TYY2.CONDO_B_ID
AND TYY1.OFLEVEL_ORDER = TYY2.OFLEVEL_ORDER
LEFT OUTER JOIN
(
SELECT CONDO_B_ID, OFLEVEL, OFLEVEL_ORDER
FROM condo.dbo.NCONDO_LEVEL
) TYY3
ON TYY1.CONDO_B_ID = TYY3.CONDO_B_ID
AND TYY1.OFLEVEL_ORDER = TYY3.OFLEVEL_ORDER
LEFT OUTER JOIN
(
SELECT ROOM_TYPE_ID, ROOM_TYPE_NAME
FROM condo.dbo.ROOM_TYPE
) TYY4
ON TYY2.ROOM_TYPE_ID = TYY4.ROOM_TYPE_ID
WHERE TYY4.ROOM_TYPE_ID IN (1,2,3,4,5,6,7,8,9,10)
ORDER BY TYY1.CONDO_B_ID, TYY1.OFLEVEL_ORDER