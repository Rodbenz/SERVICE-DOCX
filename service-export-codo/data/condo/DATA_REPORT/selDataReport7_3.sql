SELECT TTA1.DATE_PRICE, ROUND(CAST((CAST(TTA1.COUNT_ALL as numeric (10,2)) / CAST(TTA2.COUNT_ROOM as numeric (10,2))) * 100 as numeric (10,2)),0) AS COT_ROM
FROM (
SELECT DATE_PRICE, COUNT(*) COUNT_ALL
FROM (
SELECT CONDO_S_ID, CONDO_L_ID, CONDO_H_ID
FROM condo.dbo.NCONDO_HEADER
WHERE CONDO_S_ID = @CONDO_S_ID
) T1
LEFT OUTER JOIN
(
SELECT CONDO_S_ID, CONDO_H_ID, FORMAT(CAST(DATE_PRICE AS date),N'yyyy','th-TH') DATE_PRICE
FROM condo.dbo.NCONDO_SALES_ROOM
) T2
ON T1.CONDO_S_ID = T2.CONDO_S_ID
AND T1.CONDO_H_ID = T2.CONDO_H_ID
WHERE T2.DATE_PRICE IS NOT NULL
GROUP BY DATE_PRICE
) TTA1
LEFT OUTER JOIN
(
SELECT COUNT(*) COUNT_ROOM
FROM condo.dbo.NCONDO_HEADER
WHERE CONDO_S_ID = @CONDO_S_ID
) TTA2
ON 1=1