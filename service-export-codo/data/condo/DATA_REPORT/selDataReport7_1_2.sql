SELECT ROUND((SAM_PRICE_S_EDIT_PERM / countrow),0) AVG, CONDO_B_ID
FROM(
    SELECT COUNT(UNIT_NO) countrow, SUM(PRICE_S_EDIT_PERM) SAM_PRICE_S_EDIT_PERM, TTA.CONDO_B_ID
    FROM(
         SELECT T4.USE_FLG, T1.CONDO_B_ID, T1.BUILD_NO, T1.BUILD_GROUP, T2.CONDO_L_ID, T3.CONDO_H_ID, T2.OFLEVEL, T2.OFLEVEL_ORDER, T3.UNIT_NO, T3.ROOM_TYPE_ID, T4.DATE_PRICE, T4.AREA_CONTRACT, T4.PRICE_S, T4.PRICE_S_PERM, T4.PRICE_DISCOUNT, T4.PRICE_FUR, T4.PRICE_FUR_PERM, T4.SUM_PRICE_S, T4.SUM_PRICE_S_PERM, T4.PRICE_FUR_EDIT_AREA, T4.SUM_PRICE_FUR_EDIT, T4.PRICE_S_EDIT, T4.PRICE_S_EDIT_PERM
         FROM(
              SELECT CONDO_S_ID, CONDO_B_ID, BUILD_NO, BUILD_GROUP
              FROM condo.dbo.NCONDO_BUILD
              WHERE CONDO_S_ID = @CONDO_S_ID ) T1
              LEFT OUTER JOIN
             (
              SELECT CONDO_S_ID, CONDO_B_ID, CONDO_L_ID, OFLEVEL, OFLEVEL_ORDER
              FROM condo.dbo.NCONDO_LEVEL
              ) T2
              ON T1.CONDO_S_ID = T2.CONDO_S_ID AND T1.CONDO_B_ID = T2.CONDO_B_ID
              LEFT OUTER JOIN
              (
              SELECT CONDO_L_ID, CONDO_H_ID, UNIT_NO, ROOM_TYPE_ID
              FROM condo.dbo.NCONDO_HEADER
              ) T3
              ON T2.CONDO_L_ID = T3.CONDO_L_ID
              LEFT OUTER JOIN
              (
                    SELECT CONDO_H_ID, DATE_PRICE, AREA_CONTRACT, PRICE_S
                    , (PRICE_S/AREA_CONTRACT) PRICE_S_PERM
                    , PRICE_DISCOUNT, PRICE_FUR
                    , (ISNULL(PRICE_FUR,0)/ISNULL(AREA_CONTRACT,0)) PRICE_FUR_PERM
                    , ISNULL(DIFF_PRICE,0) DIFF_PRICE
                    , ((ISNULL(DIFF_PRICE,0)/100) * PRICE_S) DIFF_PRICE_FULL
                    , (PRICE_S-(ISNULL(PRICE_FUR,0)+ISNULL(PRICE_DISCOUNT,0)+((ISNULL(DIFF_PRICE,0)/100) * PRICE_S))) SUM_PRICE_S
                    , ((PRICE_S-(ISNULL(PRICE_FUR,0)+ISNULL(PRICE_DISCOUNT,0)+((ISNULL(DIFF_PRICE,0)/100) * PRICE_S)))/ISNULL(AREA_CONTRACT,0)) SUM_PRICE_S_PERM
                    , PRICE_FUR_EDIT_AREA
                    , (ISNULL(PRICE_FUR_EDIT_AREA,0)*ISNULL(AREA_CONTRACT,0)) SUM_PRICE_FUR_EDIT
                    , (PRICE_S-((ISNULL(PRICE_FUR_EDIT_AREA,0)*ISNULL(AREA_CONTRACT,0))+ISNULL(PRICE_DISCOUNT,0)+((ISNULL(DIFF_PRICE,0)/100) * PRICE_S))) PRICE_S_EDIT
                    , ((PRICE_S-((ISNULL(PRICE_FUR_EDIT_AREA,0)*ISNULL(AREA_CONTRACT,0))+ISNULL(PRICE_DISCOUNT,0)+((ISNULL(DIFF_PRICE,0)/100) * PRICE_S)))/ISNULL(AREA_CONTRACT,0)) PRICE_S_EDIT_PERM
                    , USE_FLG
                    FROM condo.dbo.NCONDO_SALES_ROOM WITH (NOLOCK)
                    ) T4
                    ON T3.CONDO_H_ID = T4.CONDO_H_ID
                    WHERE USE_FLG = 1
        )TTA
        GROUP BY TTA.CONDO_B_ID
 )TTS 