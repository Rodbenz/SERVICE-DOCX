


SELECT T1.FLOOR_VAL_ID, T1.CONDO_S_ID, T1.BUILD_NAME, T1.VAL_AMT_P_MET, T1.BUILD_GROUP, T1.OFLEVEL, T1.OFLEVEL_ORDER, T1.USE_CATG, SUM(T4.SUM_PERSONAL_P_AREA) AS SUM_PERSONAL_P_AREA, T1.FlOOR_TYPE_ID, COUNT(T4.CONDO_H_ID) COUNT_COND_H_ID
FROM (
SELECT TEST, CONDO_S_ID, VAL_AMT_P_MET, BUILD_GROUP, OFLEVEL, OFLEVEL_ORDER, BUILD_NAME, FLOOR_VAL_ID, USE_CATG, FlOOR_TYPE_ID
FROM (
  SELECT CASE WHEN CONDO_L_ID like '%,%' THEN value
  ELSE CONDO_L_ID END TEST
  ,VAL_AMT_P_MET
  ,CONDO_S_ID
  ,BUILD_GROUP, BUILD_NAME
  ,OFLEVEL, OFLEVEL_ORDER
  ,FLOOR_VAL_ID
  ,USE_CATG
  ,FlOOR_TYPE_ID
  FROM condo.dbo.CFLOOR_VAL
  CROSS APPLY string_split(condo.dbo.CFLOOR_VAL.CONDO_L_ID, ',') 
  WHERE CONDO_S_ID = @CONDO_S_ID 
) TALL
GROUP BY TEST, CONDO_S_ID, VAL_AMT_P_MET, BUILD_GROUP, OFLEVEL, OFLEVEL_ORDER, BUILD_NAME, FLOOR_VAL_ID, USE_CATG, FlOOR_TYPE_ID
) T1
LEFT OUTER JOIN
(
SELECT OFLEVEL, OFLEVEL_ORDER, CONDO_S_ID, CONDO_B_ID, CONDO_L_ID, USE_CATG, FlOOR_TYPE_ID
FROM condo.dbo.NCONDO_LEVEL
) T2
ON T1.CONDO_S_ID = T2.CONDO_S_ID
AND T1.TEST = T2.CONDO_L_ID
LEFT OUTER JOIN
(
SELECT CONDO_B_ID, CONDO_L_ID, CONDO_H_ID
FROM condo.dbo.NCONDO_HEADER
) T3
ON T2.CONDO_B_ID = T3.CONDO_B_ID
AND T2.CONDO_L_ID = T3.CONDO_L_ID
LEFT OUTER JOIN
(
SELECT CONDO_H_ID, SUM(PERSONAL_P_AREA) SUM_PERSONAL_P_AREA
FROM condo.dbo.PERSONAL_PROPERTY
GROUP BY CONDO_H_ID
) T4
ON T3.CONDO_H_ID = T4.CONDO_H_ID
WHERE RTRIM(LTRIM(T1.OFLEVEL)) NOT IN ('ชั้นดาดฟ้า', 'ดาดฟ้า')
GROUP BY T1.FLOOR_VAL_ID, T1.CONDO_S_ID, T1.BUILD_NAME, T1.VAL_AMT_P_MET, T1.BUILD_GROUP, T1.OFLEVEL, T1.OFLEVEL_ORDER, T1.USE_CATG, T1.FlOOR_TYPE_ID
ORDER BY T1.FLOOR_VAL_ID, T1.BUILD_GROUP, T1.OFLEVEL_ORDER